
/*
	Captionator 0.6 [CaptionPlanet]
	Christopher Giffard, 2011
	Share and enjoy

	https://github.com/cgiffard/Captionator
*/
/*global HTMLVideoElement: true, NodeList: true, Audio: true, HTMLElement: true, document:true, window:true, XMLHttpRequest:true, navigator:true, VirtualMediaContainer:true */
/*jshint strict:true */
/*Tab indented, tab = 4 spaces*/



!function(){"use strict";var t=10,e=16,i=4.5,n=1.5,a=[0,0,0,.5],r=!1,o={};window.captionator=o,o.CaptionatorCueStructure=function(t,e){var i=this;this.isTimeDependent=!1,this.cueSource=t,this.options=e,this.processedCue=null,this.toString=function(n){if(e.processCueHTML!==!1){var a=function(t,e){if(null===i.processedCue){var r,o,c="";for(r in t)r.match(/^\d+$/)&&t.hasOwnProperty(r)&&(o=t[r],o instanceof Object&&o.children&&o.children.length?"v"===o.token?c+='<q data-voice="'+o.voice.replace(/[\"]/g,"")+"\" class='voice speaker-"+o.voice.replace(/[^a-z0-9]+/gi,"-").toLowerCase()+" webvtt-span' title=\""+o.voice.replace(/[\"]/g,"")+'">'+a(o.children,e+1)+"</q>":"c"===o.token?c+="<span class='webvtt-span webvtt-class-span "+o.classes.join(" ")+"'>"+a(o.children,e+1)+"</span>":o.timeIn>0?null===n||void 0===n||n>0&&n>=o.timeIn?c+="<span class='webvtt-span webvtt-timestamp-span' data-timestamp='"+o.token+"' data-timestamp-seconds='"+o.timeIn+"'>"+a(o.children,e+1)+"</span>":n<o.timeIn&&(c+="<span class='webvtt-span webvtt-timestamp-span webvtt-cue-future' aria-hidden='true' style='opacity: 0;' data-timestamp='"+o.token+"' data-timestamp-seconds='"+o.timeIn+"'>"+a(o.children,e+1)+"</span>"):c+=o.rawToken+a(o.children,e+1)+"</"+o.token+">":(o instanceof String||"string"==typeof o||"number"==typeof o)&&(c+=o));return i.isTimeDependent||0!==e||(i.processedCue=c),c}return i.processedCue};return a(this,0)}return t},this.getPlain=function(i){if(e.processCueHTML!==!1){var n=function(t,e){var a,r,o="";for(a in t)a.match(/^\d+$/)&&t.hasOwnProperty(a)&&(r=t[a],r instanceof Object&&r.children&&r.children.length?r.timeIn>0?(null===i||void 0===i||i>0&&i>=r.timeIn)&&(o+=n(r.children,e+1)):o+=n(r.children,e+1):(r instanceof String||"string"==typeof r||"number"==typeof r)&&(o+=r));return o};return n(this,0)}return t.replace(/<[^>]*>/gi,"")}},o.CaptionatorCueStructure.prototype=[],o.TextTrack=function(t,e,i,n,a,r){this.onload=function(){},this.onerror=function(){},this.oncuechange=function(){},this.id=t||"",this.internalMode=o.TextTrack.OFF,this.cues=new o.TextTrackCueList(this),this.activeCues=new o.ActiveTextTrackCueList(this.cues,this),this.kind=e||"subtitles",this.label=i||"",this.language=n||"",this.src=a||"",this.readyState=o.TextTrack.NONE,this.internalDefault=r||!1,this.getMode=function(){return this.internalMode},this.setMode=function(t){var e=[o.TextTrack.OFF,o.TextTrack.HIDDEN,o.TextTrack.SHOWING];if(-1===e.indexOf(t))throw new Error("Illegal mode value for track: "+t);t!==this.internalMode&&(this.internalMode=t,this.readyState===o.TextTrack.NONE&&this.src.length>0&&t>o.TextTrack.OFF&&this.loadTrack(this.src,null),this.videoNode._captionator_dirtyBit=!0,o.rebuildCaptions(this.videoNode),t===o.TextTrack.OFF&&(this.cues.length=0,this.readyState=o.TextTrack.NONE))},this.getDefault=function(){return this.internalDefault},Object.prototype.__defineGetter__?(this.__defineGetter__("mode",this.getMode),this.__defineSetter__("mode",this.setMode),this.__defineGetter__("default",this.getDefault)):Object.defineProperty&&(Object.defineProperty(this,"mode",{get:this.getMode,set:this.setMode}),Object.defineProperty(this,"default",{get:this.getDefault})),this.loadTrack=function(t,e){var i,n=new XMLHttpRequest;if(this.readyState===o.TextTrack.LOADED)e instanceof Function&&e(i);else{this.src=t,this.readyState=o.TextTrack.LOADING;var a=this;n.open("GET",t,!0),n.onreadystatechange=function(){if(4===n.readyState)if(200===n.status){var t=a.videoNode._captionatorOptions||{};"metadata"===a.kind&&(t.processCueHTML=!1,t.sanitiseCueHTML=!1),i=o.parseCaptions(n.responseText,t),a.readyState=o.TextTrack.LOADED,a.cues.loadCues(i),a.activeCues.refreshCues.apply(a.activeCues),a.videoNode._captionator_dirtyBit=!0,o.rebuildCaptions(a.videoNode),a.onload.call(this),e instanceof Function&&e.call(a,i)}else a.readyState=o.TextTrack.ERROR,a.onerror()};try{n.send(null)}catch(r){a.readyState=o.TextTrack.ERROR,a.onerror(r)}}},this.addCue=function(t){if(!(t&&t instanceof o.TextTrackCue))throw new Error("The argument is null or not an instance of TextTrackCue.");this.cues.addCue(t)},this.removeCue=function(){}},o.TextTrack.NONE=0,o.TextTrack.LOADING=1,o.TextTrack.LOADED=2,o.TextTrack.ERROR=3,o.TextTrack.OFF=0,o.TextTrack.HIDDEN=1,o.TextTrack.SHOWING=2,o.TextTrackCue=function(t,e,i,n,a,r,c){if(this.id=t,this.track=c instanceof o.TextTrack?c:null,this.startTime=parseFloat(e),this.endTime=parseFloat(i)>=this.startTime?parseFloat(i):this.startTime,this.text="string"==typeof n||n instanceof o.CaptionatorCueStructure?n:"",this.settings="string"==typeof a?a:"",this.intSettings={},this.pauseOnExit=!!r,this.wasActive=!1,this.direction="horizontal",this.snapToLines=!0,this.linePosition="auto",this.textPosition=50,this.size=0,this.alignment="middle",this.settings.length){var s=this.intSettings,l=this;a=a.split(/\s+/).filter(function(t){return t.length>0}),a instanceof Array&&a.forEach(function(t){var e={D:"direction",L:"linePosition",T:"textPosition",A:"alignment",S:"size"};t=t.split(":"),e[t[0]]&&(s[e[t[0]]]=t[1]),e[t[0]]in l&&(l[e[t[0]]]=t[1])})}this.linePosition.match(/\%/)&&(this.snapToLines=!1),this.getCueAsSource=function(){return String(this.text)},this.getCueAsHTML=function(){var t=document.createDocumentFragment(),e=document.createElement("div");return e.innerHTML=String(this.text),Array.prototype.forEach.call(e.childNodes,function(e){t.appendChild(e.cloneNode(!0))}),t},this.isActive=function(){var t=0;if(this.track instanceof o.TextTrack&&(this.track.mode===o.TextTrack.SHOWING||this.track.mode===o.TextTrack.HIDDEN)&&this.track.readyState===o.TextTrack.LOADED)try{if(t=this.track.videoNode.currentTime,this.startTime<=t&&this.endTime>=t)return this.wasActive||(this.wasActive=!0,this.onenter()),!0}catch(e){return!1}return this.wasActive&&(this.wasActive=!1,this.onexit()),!1},Object.prototype.__defineGetter__?this.__defineGetter__("active",this.isActive):Object.defineProperty&&Object.defineProperty(this,"active",{get:this.isActive}),this.toString=function(){return"TextTrackCue:"+this.id+"\n"+String(this.text)},this.onenter=function(){},this.onexit=function(){}},o.TextTrackCueList=function(t){this.track=t instanceof o.TextTrack?t:null,this.getCueById=function(t){return this.filter(function(e){return e.id===t})[0]},this.loadCues=function(t){for(var e=0;e<t.length;e++)t[e].track=this.track,Array.prototype.push.call(this,t[e])},this.addCue=function(t){if(!(t&&t instanceof o.TextTrackCue))throw new Error("The argument is null or not an instance of TextTrackCue.");if(t.track!==this.track&&t.track)throw new Error("This cue is associated with a different track!");Array.prototype.push.call(this,t)},this.toString=function(){return"[TextTrackCueList]"}},o.TextTrackCueList.prototype=[],o.ActiveTextTrackCueList=function(t,e){this.refreshCues=function(){if(t.length){var i=this,n=!1,a=[].slice.call(this,0);if(this.length=0,t.forEach(function(t){t.active&&(i.push(t),i[i.length-1]!==a[i.length-1]&&(n=!0))}),n)try{e.oncuechange()}catch(r){}}},this.toString=function(){return"[ActiveTextTrackCueList]"},this.refreshCues()},o.ActiveTextTrackCueList.prototype=new o.TextTrackCueList(null);var c=function(t){this.targetObject=t,this.currentTime=0;var e=function(){};this.addEventListener=function(t,e){"timeupdate"===t&&e instanceof Function&&(this.timeupdateEventHandler=e)},this.attachEvent=function(t,e){"timeupdate"===t&&e instanceof Function&&(this.timeupdateEventHandler=e)},this.updateTime=function(t){isNaN(t)||(this.currentTime=t,e())}};o.rebuildCaptions=function(t){var e=t.textTracks||[],i=(t._captionatorOptions instanceof Object?t._captionatorOptions:{},t.currentTime),n=[],a=!1,r=[],c=[];if(e.forEach(function(t){t.mode===o.TextTrack.SHOWING&&t.readyState===o.TextTrack.LOADED&&(c=[].slice.call(t.activeCues,0),c=c.sort(function(t,e){return t.startTime>e.startTime?-1:1}),n=n.concat(c))}),r=n.map(function(t){return t.track.id+"."+t.id+":"+t.text.toString(i).length}),a=!o.compareArray(r,t._captionator_previousActiveCues),a||t._captionator_dirtyBit){t._captionator_dirtyBit=!1,t._captionator_availableCueArea=null,t._captionator_previousActiveCues=r,o.styleCueCanvas(t);var s=[].slice.call(t._descriptionContainerObject.getElementsByTagName("div"),0).concat([].slice.call(t._containerObject.getElementsByTagName("div"),0));s.forEach(function(t){t.cueObject&&!t.cueObject.active&&(t.cueObject.rendered=!1,t.cueObject.domNode=null,t.parentElement.removeChild(t))}),n.forEach(function(e){var n,a;"metadata"!==e.track.kind&&e.mode!==o.TextTrack.HIDDEN&&(e.rendered?(n=e.domNode,a=n.getElementsByClassName("captionator-cue-inner")[0],e.text.toString(i)!==n.currentText&&(n.currentText=e.text.toString(i),a.innerHTML=n.currentText,a.spanified=!1)):(n=document.createElement("div"),a=document.createElement("span"),a.className="captionator-cue-inner",n.id=String(e.id).length?e.id:o.generateID(),n.className="captionator-cue",n.appendChild(a),n.cueObject=e,e.domNode=n,n.setAttribute("lang",e.track.language),n.currentText=e.text.toString(i),a.innerHTML=n.currentText,e.rendered=!0,"descriptions"===e.track.kind?t._descriptionContainerObject.appendChild(n):t._containerObject.appendChild(n)),"descriptions"!==e.track.kind&&o.styleCue(n,e,t))})}},o.captionify=function(s,l,u){var d=[],p=0;if(u=u instanceof Object?u:{},u.minimumFontSize&&"number"==typeof u.minimumFontSize&&(t=u.minimumFontSize),u.minimumLineHeight&&"number"==typeof u.minimumLineHeight&&(e=u.minimumLineHeight),u.fontSizeVerticalPercentage&&"number"==typeof u.fontSizeVerticalPercentage&&(i=u.fontSizeVerticalPercentage),u.lineHeightRatio&&"number"!=typeof u.lineHeightRatio&&(n=u.lineHeightRatio),u.cueBackgroundColour&&u.cueBackgroundColour instanceof Array&&(a=u.cueBackgroundColour),!(HTMLVideoElement||s instanceof c||u.forceCaptionify))return!1;if(("function"==typeof document.createElement("video").addTextTrack||"function"==typeof document.createElement("video").addTrack)&&!u.forceCaptionify)return!1;if(!r&&u.exportObjects&&(window.TextTrack=o.TextTrack,window.TextTrackCueList=o.TextTrackCueList,window.ActiveTextTrackCueList=o.ActiveTextTrackCueList,window.TextTrackCue=o.TextTrackCue,r=!0),s&&s!==!1&&void 0!==s&&null!==s)if(s instanceof Array)for(p=0;p<s.length;p++)"string"==typeof s[p]?d=d.concat([].slice.call(document.querySelectorAll(s[p]),0)):s[p].constructor===HTMLVideoElement&&d.push(s[p]);else"string"==typeof s?d=[].slice.call(document.querySelectorAll(s),0):s.constructor===HTMLVideoElement&&d.push(s);else d=[].slice.call(document.getElementsByTagName("video"),0);return d.length?(d.forEach(function(t){t.addTextTrack=function(e,i,n,a,r,c,s){{var l,u=["subtitles","captions","descriptions","captions","metadata","chapters"];u.slice(0,7)}if(e="string"==typeof e?e:"",n="string"==typeof n?n:"",a="string"==typeof a?a:"",s="boolean"==typeof s?s:!1,u.filter(function(t){return i===t?!0:!1}).length)return l=new o.TextTrack(e,i,n,a,r,null),l?(t.textTracks instanceof Array||(t.textTracks=[]),t.textTracks.push(l),l):!1;throw o.createDOMException(12,"DOMException 12: SYNTAX_ERR: You must use a valid kind when creating a TimedTextTrack.","SYNTAX_ERR")},o.processVideoElement(t,l,u)}),!0):!1},o.parseCaptions=function(t,e){e=e instanceof Object?e:{};var i="",n=[],a="",r=[],c=/^(\d{2})?:?(\d{2}):(\d{2})\.(\d+)\,(\d{2})?:?(\d{2}):(\d{2})\.(\d+)\s*(.*)/,s=/^(\d+)?:?(\d{2}):(\d{2})\.(\d+)\,(\d+)?:?(\d{2}):(\d{2})\.(\d+)\s*(.*)/,l=/^(\d{2})?:?(\d{2}):(\d{2})[\.\,](\d+)\s+\-\-\>\s+(\d{2})?:?(\d{2}):(\d{2})[\.\,](\d+)\s*(.*)/,u=/(\d{2})?:?(\d{2}):(\d{2})[\.\,](\d+)/,d=/^([\d\.]+)\s+\+([\d\.]+)\s*(.*)/,p=/^\[(\d{2})?:?(\d{2})\:(\d{2})\.(\d{2,3})\]\s*(.*?)$/,h=/^(DEFAULTS|DEFAULT)\s+\-\-\>\s+(.*)/g,f=/^(STYLE|STYLES)\s+\-\-\>\s*\n([\s\S]*)/g,g=/^(COMMENT|COMMENTS)\s+\-\-\>\s+(.*)/g,T=/<tt\s+xml/gi,v=/^(\d{2})?:?(\d{2}):(\d{2})\.(\d+)/;if(t){var m=function(t){var i,n,a,r,c,s=new o.CaptionatorCueStructure(t,e),l=[],d=[],p=0,h=function(t){return!!t.replace(/[^a-z0-9]+/gi,"").length};l=t.split(/(<\/?[^>]+>)/gi),a=s;for(i in l)if(l.hasOwnProperty(i))if(n=l[i],"<"===n.substr(0,1)){if("/"===n.substr(1,1)){var f=n.substr(2).split(/[\s>]+/g)[0];if(d.length>0){var g=0;for(p=d.length-1;p>=0;p--){var T=d[p][d[p].length-1];if(g=p,T.token===f)break}a=d[g],d=d.slice(0,g)}}else if(n.substr(1).match(u)||n.match(/^<v\s+[^>]+>/i)||n.match(/^<c[a-z0-9\-\_\.]+>/)||n.match(/^<(b|i|u|ruby|rt)>/)||e.sanitiseCueHTML!==!1){var v={token:n.replace(/[<\/>]+/gi,"").split(/[\s\.]+/)[0],rawToken:n,children:[]};"v"===v.token?v.voice=n.match(/^<v\s*([^>]+)>/i)[1]:"c"===v.token?v.classes=n.replace(/[<\/>\s]+/gi,"").split(/[\.]+/gi).slice(1).filter(h):(r=v.rawToken.match(u))&&(s.isTimeDependent=!0,c=r.slice(1),v.timeIn=parseInt(60*(c[0]||0)*60,10)+parseInt(60*(c[1]||0),10)+parseInt(c[2]||0,10)+parseFloat("0."+(c[3]||0))),a.push(v),d.push(a),a=v.children}}else e.sanitiseCueHTML!==!1&&(n=n.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\&/g,"&amp;"),e.ignoreWhitespace||(n=n.replace(/\n+/g,"<br />"))),a.push(n);return s},C=function(t,n){var u,T,v,C,b,x,y,_,k,A,w="";if(_=h.exec(t))return r=_.slice(2).join(""),r=r.split(/\s+/g).filter(function(t){return t&&!!t.length}),null;if(_=f.exec(t))return a+=_[_.length-1],null;if(_=g.exec(t))return null;for(u="LRC"===i?[t.substr(0,t.indexOf("]")+1),t.substr(t.indexOf("]")+1)]:t.split(/\n/g);!u[0].replace(/\s+/gi,"").length&&u.length>0;)u.shift();for(y=u[0].match(/^\s*[a-z0-9\-]+\s*$/gi)?String(u.shift().replace(/\s*/gi,"")):n,x=0;x<u.length;x++){var S=u[x];(k=l.exec(S))||(k=c.exec(S))||(k=s.exec(S))?(b=k.slice(1),T=parseInt(60*(b[0]||0)*60,10)+parseInt(60*(b[1]||0),10)+parseInt(b[2]||0,10)+parseFloat("0."+(b[3]||0)),v=parseInt(60*(b[4]||0)*60,10)+parseInt(60*(b[5]||0),10)+parseInt(b[6]||0,10)+parseFloat("0."+(b[7]||0)),b[8]&&(w=b[8])):(k=d.exec(S))?(b=k.slice(1),T=parseFloat(b[0]),v=T+parseFloat(b[1]),b[2]&&(w=b[2])):(k=p.exec(S))&&(b=k.slice(1,k.length-1),T=parseInt(60*(b[0]||0)*60,10)+parseInt(60*(b[1]||0),10)+parseInt(b[2]||0,10)+parseFloat("0."+(b[3]||0)),v=T),u=u.slice(0,x).concat(u.slice(x+1));break}if(!T&&!v)return null;var O=r.reduce(function(t,e){return t[e.split(":")[0]]=e.split(":")[1],t},{});O=w.split(/\s+/g).filter(function(t){return t&&!!t.length}).reduce(function(t,e){return t[e.split(":")[0]]=e.split(":")[1],t},O),w="";for(var E in O)O.hasOwnProperty(E)&&(w+=w.length?" ":"",w+=E+":"+O[E]);return C=e.processCueHTML===!1?u.join("\n"):m(u.join("\n")),A=new o.TextTrackCue(y,T,v,C,w,!1,null),A.styleData=a,A},b=function(t){var e,i=0;return"string"!=typeof t?0:((e=v.exec(t))&&(e=e.slice(1),i=parseInt(60*(e[0]||0)*60,10)+parseInt(60*(e[1]||0),10)+parseInt(e[2]||0,10)+parseFloat("0."+(e[3]||0))),i)},x=function(t,i){var n,a=0,r=0,c=String(t.getAttribute("begin")),s=String(t.getAttribute("end")),l=t.getAttribute("id")||i;return a=b(c),r=b(s),n=e.processCueHTML===!1?t.innerHTML:m(t.innerHTML),new o.TextTrackCue(l,a,r,n,{},!1,null)};if(n=t.replace(/\r\n/g,"\n").replace(/\r/g,"\n"),T.exec(t)){var y=document.createElement("ttml");y.innerHTML=t;var _=[].slice.call(y.querySelectorAll("[begin],[end]"),0),k=_.map(x);return k}return t.split(/\n+/g).reduce(function(t,e){return t||!!p.exec(e)},!1)?(n=n.split(/\n+/g),i="LRC"):n=n.split(/\n\n+/g),n=n.filter(function(t){return t.match(/^WEBVTT(\s*FILE)?/gi)?(i="WebVTT",!1):t.replace(/\s*/gi,"").length?!0:!1}).map(C).filter(function(t){return null!==t?!0:!1}),"LRC"===i&&(n.forEach(function(t,e){var i,a=0;e>0&&(a=t.startTime,i=n[--e],i.endTime<a&&(i.endTime=a))}),n=n.filter(function(t){return t.text.toString().replace(/\s*/,"").length>0?!0:!1})),n}throw new Error("Required parameter captionData not supplied.")},o.processVideoElement=function(t,e,i){{var n=[],a=navigator.language||navigator.userLanguage;e||a.split("-")[0]}if(i=i instanceof Object?i:{},!t.captioned){t._captionatorOptions=i,t.className+=(t.className.length?" ":"")+"captioned",t.captioned=!0,0===t.id.length&&(t.id=o.generateID());[].slice.call(t.querySelectorAll("track"),0).forEach(function(a){var r=null;r=a.querySelectorAll("source").length>0?a.querySelectorAll("source"):a.getAttribute("src");var c=t.addTextTrack(a.getAttribute("id")||o.generateID(),a.getAttribute("kind"),a.getAttribute("label"),a.getAttribute("srclang").split("-")[0],r,a.getAttribute("type"),a.hasAttribute("default"));a.track=c,c.trackNode=a,c.videoNode=t,n.push(c);var s=!1;"subtitles"!==c.kind&&"captions"!==c.kind||e!==c.language||!i.enableCaptionsByDefault||n.filter(function(t){return"captions"!==t.kind&&"subtitles"!==t.kind||e!==t.language||t.mode!==o.TextTrack.SHOWING?!1:!0}).length||(s=!0),"chapters"===c.kind&&e===c.language&&(n.filter(function(t){return"chapters"===t.kind&&t.mode===o.TextTrack.SHOWING?!0:!1}).length||(s=!0)),"descriptions"===c.kind&&i.enableDescriptionsByDefault===!0&&e===c.language&&(n.filter(function(t){return"descriptions"===t.kind&&t.mode===o.TextTrack.SHOWING?!0:!1}).length||(s=!0)),s===!0&&n.forEach(function(t){t.trackNode.hasAttribute("default")&&t.mode===o.TextTrack.SHOWING&&(t.mode=o.TextTrack.HIDDEN)}),a.hasAttribute("default")&&(n.filter(function(t){return t.trackNode.hasAttribute("default")&&t.trackNode!==a?!0:!1}).length||(s=!0,c.internalDefault=!0)),s===!0&&(c.mode=o.TextTrack.SHOWING)}),t.addEventListener("timeupdate",function(t){var e=t.target;try{e.textTracks.forEach(function(t){t.activeCues.refreshCues.apply(t.activeCues)})}catch(n){}i.renderer instanceof Function?i.renderer.call(o,e):o.rebuildCaptions(e)},!1),window.addEventListener("resize",function(){t._captionator_dirtyBit=!0,o.rebuildCaptions(t)},!1),i.enableHighResolution===!0&&window.setInterval(function(){try{t.textTracks.forEach(function(t){t.activeCues.refreshCues.apply(t.activeCues)})}catch(e){}i.renderer instanceof Function?i.renderer.call(o,t):o.rebuildCaptions(t)},20)}return t},o.getNodeMetrics=function(t){var e=window.getComputedStyle(t,null),i=t,n=t.offsetTop,a=t.offsetLeft,r=t,o=0,c=0;for(r=parseInt(e.getPropertyValue("width"),10),o=parseInt(e.getPropertyValue("height"),10);i=i.offsetParent;)n+=i.offsetTop,a+=i.offsetLeft;if(t.hasAttribute("controls")){var s=navigator.userAgent.toLowerCase();-1!==s.indexOf("chrome")?c=32:-1!==s.indexOf("opera")?c=25:-1!==s.indexOf("firefox")?c=28:-1!==s.indexOf("ie 9")||-1!==s.indexOf("ipad")?c=44:-1!==s.indexOf("safari")&&(c=25)}else if(t._captionatorOptions){var l=t._captionatorOptions;l.controlHeight&&(c=parseInt(l.controlHeight,10))}return{left:a,top:n,width:r,height:o,controlHeight:c}},o.applyStyles=function(t,e){for(var i in e)({}).hasOwnProperty.call(e,i)&&(t.style[i]=e[i])},o.checkDirection=function(t){var e="A-Za-zÀ-ÖØ-öø-ʸ̀-֐ࠀ-῿Ⰰ-﬜﷾-﹯﻽-￿",i="֑-߿יִ-﷽ﹰ-ﻼ",n=new RegExp("^[^"+i+"]*["+e+"]"),a=new RegExp("^[^"+e+"]*["+i+"]");return a.test(t)?"rtl":n.test(t)?"ltr":""},o.styleCue=function(r,c,s){var l,u,d,p,h,f,g,T,v,m,C,b,x,y,_=0,k=0,A=0,w=0,S=0,O=0,E=0,L=0,N=0,H=0,M=0,D=0,I=0,P=0,F=s._captionatorOptions||{},j=50,z=0,R=0,B=!0,G="",V=(c.track.language,function(t){if(t.spanified)return t.characterCount;var e,i,n,a,r=function(t){return!!t.length},c="<span class='captionator-cue-character'>",s=0,l=function(t){s++,o.applyStyles(t,{display:"block",lineHeight:"auto",height:p+"px",width:m+"px",textAlign:"center"})};for(e in t.childNodes)t.childNodes.hasOwnProperty(e)&&!t.childNodes[e].nospan&&(i=t.childNodes[e],3===i.nodeType?(a=document.createDocumentFragment(),n=i.nodeValue,a.appendChild(document.createElement("span")),a.childNodes[0].innerHTML=c+n.split(/(.)/).filter(r).join("</span>"+c)+"</span>",[].slice.call(a.querySelectorAll("span.captionator-cue-character"),0).forEach(l),i.parentNode.replaceChild(a,i)):1===t.childNodes[e].nodeType&&(s+=V(t.childNodes[e])));return t.characterCount=s,t.spanified=!0,s});if(x=o.getNodeMetrics(s),s._captionator_availableCueArea||(s._captionator_availableCueArea={bottom:x.height-x.controlHeight,right:x.width,top:0,left:0,height:x.height-x.controlHeight,width:x.width}),"horizontal"===c.direction&&(o.applyStyles(r,{width:"auto",position:"static",display:"inline-block",padding:"1em"}),z=parseInt(r.offsetWidth,10),R=Math.floor(z/s._captionator_availableCueArea.width*100),R=100>=R?R:100),d=x.height*(i/100)/96*72,d=d>=t?d:t,p=Math.floor(d/72*96),h=Math.floor(d*n),h=h>e?h:e,v=Math.ceil(h/72*96),m=v,v*Math.floor(x.height/v)<x.height&&(v=Math.floor(x.height/Math.floor(x.height/v)),h=Math.ceil(v/96*72)),v*Math.floor(x.width/v)<x.width&&(m=Math.ceil(x.width/Math.floor(x.width/v))),g=Math.floor(s._captionator_availableCueArea.height/v),T=Math.floor(s._captionator_availableCueArea.width/m),0===parseFloat(String(c.size).replace(/[^\d\.]/gi,""))?F.sizeCuesByTextBoundingBox===!0?l=R:(l=100,B=!1):(B=!1,l=parseFloat(String(c.size).replace(/[^\d\.]/gi,"")),l=100>=l?l:100),S="horizontal"===c.direction?Math.floor(.01*x.width):0,O="horizontal"===c.direction?0:Math.floor(.01*x.height),"auto"===c.linePosition?c.linePosition="horizontal"===c.direction?g:T:String(c.linePosition).match(/\%/)&&(c.snapToLines=!1,c.linePosition=parseFloat(String(c.linePosition).replace(/\%/gi,""))),"horizontal"===c.direction)w=v,"auto"!==c.textPosition&&B&&(j=parseFloat(String(c.textPosition).replace(/[^\d\.]/gi,"")),l-j>R?l-=j:l=R),A=c.snapToLines===!0?s._captionator_availableCueArea.width*(l/100):x.width*(l/100),"auto"===c.textPosition?_=(s._captionator_availableCueArea.right-A)/2+s._captionator_availableCueArea.left:(j=parseFloat(String(c.textPosition).replace(/[^\d\.]/gi,"")),_=(s._captionator_availableCueArea.right-A)*(j/100)+s._captionator_availableCueArea.left),c.snapToLines===!0?k=(g-1)*v+s._captionator_availableCueArea.top:(f=x.controlHeight+v+2*O,k=(x.height-f)*(c.linePosition/100));else{if(k=s._captionator_availableCueArea.top,_=s._captionator_availableCueArea.right-m,A=m,w=s._captionator_availableCueArea.height*(l/100),L=V(r),N=[].slice.call(r.querySelectorAll("span.captionator-cue-character"),0),E=Math.floor((w-2*O)/p),A=Math.ceil(L/E)*m,H=Math.ceil(L/E),M=L-E*(H-1),D=M*p,c.snapToLines===!0)_="vertical-lr"===c.direction?s._captionator_availableCueArea.left:s._captionator_availableCueArea.right-A;else{var q=A+2*S;_="vertical-lr"===c.direction?(x.width-q)*(c.linePosition/100):x.width-q-(x.width-q)*(c.linePosition/100)}"auto"===c.textPosition?k=(s._captionator_availableCueArea.bottom-w)/2+s._captionator_availableCueArea.top:(c.textPosition=parseFloat(String(c.textPosition).replace(/[^\d\.]/gi,"")),k=(s._captionator_availableCueArea.bottom-w)*(c.textPosition/100)+s._captionator_availableCueArea.top),I=0,P=0,C=0,b=0,N.forEach(function(t){C="vertical-lr"===c.direction?m*I:A-m*(I+1),"start"===c.alignment||"start"!==c.alignment&&H-1>I?b=P*p+O:"end"===c.alignment?b=P*p-p+(w+2*O-D):"middle"===c.alignment&&(b=(w-2*O-D)/2+P*p),t.setAttribute("aria-hidden","true"),o.applyStyles(t,{position:"absolute",top:b+"px",left:C+"px"}),P>=E-1?(P=0,I++):P++}),r.accessified||(G=c.text.getPlain(s.currentTime),y=document.createElement("div"),y.innerHTML=G,y.nospan=!0,r.appendChild(y),r.accessified=!0,o.applyStyles(y,{position:"absolute",overflow:"hidden",width:"1px",height:"1px",opacity:"0",textIndent:"-999em"}))}if("horizontal"===c.direction&&(u="rtl"===o.checkDirection(String(c.text))?{start:"right",middle:"center",end:"left"}[c.alignment]:{start:"left",middle:"center",end:"right"}[c.alignment]),o.applyStyles(r,{position:"absolute",overflow:"hidden",width:A+"px",height:w+"px",top:k+"px",left:_+"px",padding:O+"px "+S+"px",textAlign:u,backgroundColor:"rgba("+a.join(",")+")",direction:o.checkDirection(String(c.text)),lineHeight:h+"pt",boxSizing:"border-box"}),"vertical"===c.direction||"vertical-lr"===c.direction)_-s._captionator_availableCueArea.left-s._captionator_availableCueArea.left>=s._captionator_availableCueArea.right-(_+A)?s._captionator_availableCueArea.right=_:s._captionator_availableCueArea.left=_+A,s._captionator_availableCueArea.width=s._captionator_availableCueArea.right-s._captionator_availableCueArea.left;else{if(r.scrollHeight>1.2*r.offsetHeight)if(c.snapToLines){for(var W=0;r.scrollHeight>1.2*r.offsetHeight;)w+=v,r.style.height=w+"px",W++;k-=W*v,r.style.top=k+"px"}else{{r.scrollHeight-w}w=r.scrollHeight+O,f=x.controlHeight+w+2*O,k=(x.height-f)*(c.linePosition/100),r.style.height=w+"px",r.style.top=k+"px"}k-s._captionator_availableCueArea.top-s._captionator_availableCueArea.top>=s._captionator_availableCueArea.bottom-(k+w)&&s._captionator_availableCueArea.bottom>k?s._captionator_availableCueArea.bottom=k:s._captionator_availableCueArea.top<k+w&&(s._captionator_availableCueArea.top=k+w),s._captionator_availableCueArea.height=s._captionator_availableCueArea.bottom-s._captionator_availableCueArea.top}if(F.debugMode){var Y,$,X=function(){Y||(s._captionatorDebugCanvas?(Y=s._captionatorDebugCanvas,$=s._captionatorDebugContext):(Y=document.createElement("canvas"),Y.setAttribute("width",x.width),Y.setAttribute("height",x.height-x.controlHeight),document.body.appendChild(Y),o.applyStyles(Y,{position:"absolute",top:x.top+"px",left:x.left+"px",width:x.width+"px",height:x.height-x.controlHeight+"px",zIndex:3e3}),$=Y.getContext("2d"),s._captionatorDebugCanvas=Y,s._captionatorDebugContext=$))},U=function(){X(),Y.setAttribute("width",x.width)},Z=function(){var t;for(X(),$.strokeStyle="rgba(255,0,0,0.5)",$.lineWidth=1,$.beginPath(),t=0;g>t;t++)$.moveTo(.5,t*v+.5),$.lineTo(x.width,t*v+.5);for($.closePath(),$.stroke(),$.beginPath(),$.strokeStyle="rgba(0,255,0,0.5)",t=T;t>=0;t--)$.moveTo(x.width-t*m-.5,-.5),$.lineTo(x.width-t*m-.5,x.height);for($.closePath(),$.stroke(),$.beginPath(),$.strokeStyle="rgba(255,255,0,0.5)",t=0;T>=t;t++)$.moveTo(t*m+.5,-.5),$.lineTo(t*m+.5,x.height);$.stroke(),s.linesDrawn=!0},J=function(){X(),$.fillStyle="rgba(100,100,255,0.5)",$.fillRect(s._captionator_availableCueArea.left,s._captionator_availableCueArea.top,s._captionator_availableCueArea.right,s._captionator_availableCueArea.bottom),$.stroke()};U(),J(),Z()}},o.styleCueCanvas=function(a){var r,c,s,l,u,d,p=a._captionatorOptions instanceof Object?a._captionatorOptions:{};if(!(a instanceof HTMLVideoElement))throw new Error("Cannot style a cue canvas for a non-video node!");if(a._containerObject&&(s=a._containerObject,u=s.id),a._descriptionContainerObject&&(l=a._descriptionContainerObject,d=l.id),l?l.parentNode||document.body.appendChild(l):(l=document.createElement("div"),l.className="captionator-cue-descriptive-container",d=o.generateID(),l.id=d,a._descriptionContainerObject=l,l.setAttribute("aria-live","polite"),l.setAttribute("aria-atomic","true"),l.setAttribute("role","region"),document.body.appendChild(l),o.applyStyles(l,{position:"absolute",overflow:"hidden",width:"1px",height:"1px",opacity:"0",textIndent:"-999em"})),s)s.parentNode||document.body.appendChild(s);else{if(s=document.createElement("div"),s.className="captionator-cue-canvas",u=o.generateID(),s.id=u,p.appendCueCanvasTo){var h=null;if(p.appendCueCanvasTo instanceof HTMLElement)h=p.appendCueCanvasTo;else if("string"==typeof p.appendCueCanvasTo)try{var f=document.querySelectorAll(p.appendCueCanvasTo);if(!(f.length>0))throw null;h=f[0]}catch(g){h=document.body,p.appendCueCanvasTo=!1}else h=document.body,p.appendCueCanvasTo=!1;h.appendChild(s)}else document.body.appendChild(s);a._containerObject=s}var T=o.getNodeMetrics(a);r=T.height*(i/100)/96*72,r=r>=t?r:t,c=Math.floor(r*n),c=c>e?c:e,o.applyStyles(s,{pointerEvents:"none",position:"absolute",overflow:"hidden",zIndex:100,height:T.height-T.controlHeight+"px",width:T.width+"px",top:(p.appendCueCanvasTo?0:T.top)+"px",left:(p.appendCueCanvasTo?0:T.left)+"px",color:"white",fontFamily:"Verdana, Helvetica, Arial, sans-serif",fontSize:r+"pt",lineHeight:c+"pt",boxSizing:"border-box"})},o.createDOMException=function(t,e,i){try{document.querySelectorAll("div/[]")}catch(n){var a=function(t,e,i){this.code=t,this.message=e,this.name=i};return a.prototype=n,new a(t,e,i)}},o.compareArray=function(t,e){if(!(t instanceof Array&&e instanceof Array))return!1;if(t.length!==e.length)return!1;for(var i in t)if(t.hasOwnProperty(i)&&t[i]!==e[i])return!1;return!0},o.generateID=function(t){var e="";for(t=t?t:10;e.length<t;)e+=String.fromCharCode(65+Math.floor(26*Math.random()));return"captionator"+e}}();